<!DOCTYPE html>
<html>

<head>
  <title>Naive Theories</title>
  <script src="https://unpkg.com/jspsych@8.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.0.0"></script>
  <script src="jspsych/plugin-survey.js"></script>
  <link rel="stylesheet" href="jspsych/plugin-survey.css">
  <script src="https://unpkg.com/@jspsych/plugin-survey-multi-choice@1.1.3"></script>
  <!-- load in the scientific statements js-->
  <script src="stimuli/shtulman_2012_scientific_statements.js"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-text@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-fullscreen@1.2.1"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey@2.0.0"></script>
  <link href="https://unpkg.com/jspsych@8.0.0/css/jspsych.css" rel="stylesheet" type="text/css" />
  <script src="https://unpkg.com/@jspsych/plugin-survey@4.0.0"></script>
  <link rel="stylesheet" href="https://unpkg.com/@jspsych/plugin-survey@4.0.0/css/survey.min.css">
</head>

<body></body>
<script>

  // initialize jsPsych 
  var jsPsych = initJsPsych({ 
    on_finish: function() { 
      jsPsych.data.displayData(); 
    } 
  });

  // create timeline
  var timeline = [];

  // load in stimulus list 
  // IDEA: convert the csv to json format and store that item as a variable in .js code (loaded above)
  // each element in the variable scientific statements is one row in the csv, structured as an Object/ dictionary
  // you can view the structure by looking in the console

  // full screen
  var fullscreen = {
    type: jsPsychFullscreen,
    fullscreen_mode: true
  };
  timeline.push(fullscreen);

  // welcome message trial
  var welcome = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: "<p>Welcome to the experiment.<br><br>You will see several statements about science and math.<br><br>Please read the statements and respond with whether you think they are <b>true (Z key)</b> or <b>false (M key)</b> as quickly as possible.<br><br>Press any key to begin.</p>"
  };
  timeline.push(welcome);

  // collecting participant ID
  var participant_id_entry = {
    type: jsPsychSurveyText,
    questions: [
      { prompt: "Please enter your participant ID (e.g., p1):", name: "participant_id" } ],
    on_finish: function(data){
      console.log(data.response)
      jsPsych.data.addProperties({
        participant_id: data.response.participant_id
      });
    }
  };
  timeline.push(participant_id_entry);

  // get a list of unique category names from scientific_statements array
  var categories = [...new Set(scientific_statements.map(x => x.Category))];
  // randomize categories (domains) shown to participants
  categories = jsPsych.randomization.shuffle(categories);


  // core trials with statements
  var statement_trial = {
    type: jsPsychHtmlKeyboardResponse,
    prompt: "<p><br>Press <b>Z</b> if true and <b>M</b> if false.</br></p>",
    stimulus: function() {
      return '<div style="font-size:30pt;">' + jsPsych.evaluateTimelineVariable('Statement') + '</div>';
    }, // added here to make statement font size bigger than the reminder note about pressing Z or M
    choices: ['z','m','t'],
    // data we are recording per trial (domain/category, scientific theory answer, naive theory answer, concept tested, mean proportion answered correct, mean answering response time)
    data: function (){
      return{
      category: jsPsych.timelineVariable('Category'),
      correct_response: jsPsych.timelineVariable('T2'),
      naive_theory: jsPsych.timelineVariable('T1'),
      concept: jsPsych.timelineVariable('Concept'),
      m_prop_correct: jsPsych.timelineVariable('M proportion correct'),
      m_rt: jsPsych.timelineVariable('M response time (ms)'),
      };
    },
    on_finish: function(data){
      data.is_consistent = data.naive_theory === data.correct_response; // mark whether the scientific theory "consistent" with naive theory
      // convert the raw key press ("Z" or "M") into "T" or "F"
      if(data.response === "z"){
        data.response_tf = "T";
      } else if(data.response === "m"){
        data.response_tf = "F";
      }
       else if(data.response === "m"){
        data.response_tf = "F";
      }
      //compute accuracy
      data.correct = data.response_tf === data.correct_response;
    }
  };
    
  // create category blocks with all of the statements 
  for (var i = 9; i < categories.length; i++){ // iterate through the domains (10)
  let category = categories[i];
    // intro screen for the category (domain)
    var before_category = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: "<p>Now you will see statements about <b>" + category + "</b>...</p>",
      choices: "ALL_KEYS"
    };
    timeline.push(before_category);

    // statements for that category (total of 20), makes new array (category_statements) containing only statements from that specific category/domain
    let category_statements = scientific_statements.filter(x => x.Category === category);

    //push the trials for that category to the timeline, randomizing the order of the statements within the category
    timeline.push({
      timeline: [statement_trial],
      timeline_variables: category_statements,
      randomize_order: true
    });
  } //closing the for loop


  // closing of the experiment with closing message
  var end_experiment = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `
      <p>Thank you for completing this portion of the 
      experiment. We now have a few  questions for you.</p>
      <p>Press any key to proceed, and click submit once you are 
      done with the questions. Thanks! </p>
      `};
  timeline.push(end_experiment);

  // demographic questions
  var demographics1 = { 
      type: jsPsychSurveyMultiChoice,
        questions: [
          {
            prompt: "What is your grade level?", 
            name: 'grade', 
            options: ['1st Year', '2nd Year', '3rd Year', '4th Year', '5th+ Year'],
            required: true
          }, 
          {
            prompt: "What is your gender identity?", 
            name: 'gender', 
            options: ['Male', 'Female', 'Non-binary', 'Prefer not to say', 'Other'], 
            showOtherItem: true,
            required: true
          }
        ],
  };

 var demographics2 = {
      type: jsPsychSurvey,
      survey_json:{
          showQuestionNumbers: false,
          elements: [
              {type: 'text',
              title: "What is your age? Please input a number.",
              name: 'age',
              inputType: 'number'
              },
              {type: 'text',
              title: "What is your major?",
              name: 'major'
              },
              {type: 'text',
              title: "What do you think this experiment was about?",
              name: 'experiment_topic'
              },
              {type: 'text',
              title: "Did you experience any technical difficulties in this experiment?",
              name: 'technical_difficulties'
              }
          ]
      }
  };

  timeline.push(demographics1, demographics2);

  // debrief of the experiment
  var debrief = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `
      <p> And that is the end of our experiment! Thanks for participating, we really appreciate it :)<br> </p>
      <p> Our study investigates whether learning new science and math concepts replaces people's </p>
        <p>intuitive beliefs or if those beliefs continue to hold even after learning the correct scientific concepts.</p>
      `};
  timeline.push(debrief);

  /* start the experiment */
  jsPsych.run(timeline);
</script>

</html>
